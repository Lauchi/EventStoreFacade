pool:
  vmImage: Hosted VS2017
  demands: java

steps:
  - task: DotNetCoreCLI@2
    displayName: Restore
    inputs:
      command: restore
      projects: '$(Parameters.RestoreBuildProjects)'

  - task: SonarSource.sonarcloud.14d9cde6-c1da-4d55-aa01-2965cd301255.SonarCloudPrepare@1
    displayName: 'Prepare analysis on SonarCloud'
    inputs:
      SonarCloud: Microwave
      organization: 'lauchi-github'
      projectKey: 'Lauchi_Microwave'
      projectVersion: '$(Build.BuildNumber)'
      extraProperties: 'sonar.cs.opencover.reportsPaths="$(Build.ArtifactStagingDirectory)\coverage.xml"'

  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      projects: '$(Parameters.RestoreBuildProjects)'
      arguments: '--configuration $(BuildConfiguration)'

  - powershell: |
      New-Item -ItemType Directory -Force -Path "C:\Program Files\MongoDB\data\db"
      choco install mongodb
      & "C:\Program Files\MongoDB\Server\4.0\bin\mongod.exe" --dbpath "C:\Program Files\MongoDB\data\db" --logpath="C:\Program Files\MongoDB\data\log.txt" --install
    errorActionPreference: silentlyContinue
    ignoreLASTEXITCODE: true
    displayName: 'install mongodb'
    continueOnError: true

  - powershell: |
      choco install opencover.portable
      OpenCover.Console.exe -register:user -target:"C:/Program Files/dotnet/dotnet.exe" -targetargs:test -filter:+[*]* -output:"coverage.xml" -oldstyle
    ignoreLASTEXITCODE: true
    displayName: 'test with coveralls'

  - task: DotNetCoreCLI@2
    displayName: 'dotnet pack'
    inputs:
      command: pack
      versioningScheme: byEnvVar
      versionEnvVar: ReplacedAssemblyVersion

  - task: DotNetCoreCLI@2
    displayName: 'dotnet push'
    inputs:
      command: push
      publishVstsFeed: '5cd28365-19fd-4f0b-b3ab-7012b832d098'

  - task: CopyFiles@2
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
    inputs:
      Contents: '**/*.xml'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
      CleanTargetFolder: true
      OverWrite: true
      flattenFolders: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: drop'

  - task: SonarSource.sonarcloud.ce096e50-6155-4de8-8800-4221aaeed4a1.SonarCloudAnalyze@1
    displayName: 'Run Code Analysis'

